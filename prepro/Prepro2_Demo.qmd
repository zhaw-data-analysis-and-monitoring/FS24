---
date: 2023-10-16
lesson: PrePro2
topic: Piping / Joins
index: 1
knitr:
  opts_chunk:
    collapse: true
---

# Prepro 2: Demo

The code for this demo can also [be downloaded as an R Script](Prepro2_Demo.R) (right click → *Save Target As..*)

## Piping

We want to extract the temperature data from a character string (`diary`), and then convert the Kelvin value into Celsius according to the following formula, before finally calculating the mean of all the values:

$$°C = K - 273.15$$

```{r}
diary <- c(
  "The temperature is 310° Kelvin",
  "The temperature is 322° Kelvin",
  "The temperature is 410° Kelvin"
)

diary
```

To do this, we need the `substr()` function, which can extract part of a `character`.

```{r}
# If the letters were individual _elements_ of a vector, we would subset them like this:

charvec1 <- c("a", "b", "c", "d", "e", "f", "g", "h")
charvec1[4:6]

# But if these are stored in a single character, we need substr:
charvec2 <- "abcdefgh"
substr(charvec2, 4, 6)
```

We also need the auxiliary subtraction function, `substract`, which accepts two values, the `minuend` and the `subtrahend`:

```{r}
subtract <- function(minuend, subtrahend) {
  minuend - subtrahend
}

subtract(10, 4)
```

Translated into `R`-code, this results in the following operation:

```{r}
output <- mean(subtract(as.numeric(substr(diary, 20, 22)), 273.15))
#                                         \_1_/
#                                  \________2__________/
#                       \___________________3__________/
#              \____________________________4____________________/
#         \_________________________________5____________________/

# 1. Take diary
# 2. Extract values 20 to 22 on each line
# 3. Convert "character" to "numeric"
# 4. Subtract 273.15
# 5. Calculate the mean
```

The whole operation is a little easier to read if it is written down sequentially:

```{r}
temp <- substr(diary, 20, 22)  # 2
temp <- as.numeric(temp)       # 3
temp <- subtract(temp, 273.15) # 4
output <- mean(temp)           # 5
```

The fact that the intermediate results must always be saved and retrieved again in the subsequent operation makes this somewhat cumbersome. This is where "piping" comes into play: *It makes the output of one function the first parameter of the subsequent function.*

```{r}
diary |>              # 1
  substr(20, 22) |>   # 2
  as.numeric() |>     # 3
  subtract(273.15) |> # 4
  mean()              # 5
```

:::{.callout-important}
- the `|>` pipe operator was first introduced in R `4.1`
- In addition to the *base R* pipe operator, there is also a very similar[^pipe] pipe operator, `%>%`, in the `magrittr` package.
- The <kbd>Ctrl</kbd> +<kbd>Shift</kbd>+<kbd>M</kbd> keyboard shortcut in RStudio inserts a pipe operator.
- By checking the Use native pipe operator setting in RStudio Settings `Tools` → `Global Options` → `Code`, you can control which `pipe operator`, `|>` or `%>%`, is inserted with the above key combination.
- We recommend using the base-R pipe operator `|>`
:::

[^pipe]: see <https://stackoverflow.com/q/67633022/4139249>

## Joins

```{r}
students <- data.frame(
  Matriculation_No = c(100002, 100003, 200003),
  Student = c("Patrick", "Manuela", "Eva"),
  ZIP = c(8006, 8001, 8820)
)

students

localities <- data.frame(
  ZIP = c(8003, 8006, 8810, 8820),
  LocalityName = c("Zurich", "Zurich", "Horgen", "Wadenswil")
)

localities
```

```{r}
# Load library
library("dplyr")

inner_join(students, localities, by = "ZIP")

left_join(students, localities, by = "ZIP")

right_join(students, localities, by = "ZIP")

full_join(students, localities, by = "ZIP")
```

```{r}
students <- data.frame(
  Matriculation_No = c(100002, 100003, 200003),
  Student = c("Patrick", "Manuela", "Pascal"),
  Residence = c(8006, 8001, 8006)
)

left_join(students, localities, by = c("Residence" = "ZIP"))
```

```{r}
#| purl: false
#| echo: false
#| output: false

knitr::purl("prepro/Prepro2_Demo.qmd", "prepro/Prepro2_Demo.R", documentation = 0)
```
